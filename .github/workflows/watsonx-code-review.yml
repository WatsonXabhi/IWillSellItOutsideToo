name: WatsonX Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  watsonx-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get IBM Cloud IAM Token
        env:
          IBM_CLOUD_API_KEY: ${{ secrets.WATSONX_API_KEY }}  # Your IBM Cloud API key stored as secret
        id: get_token
        run: |
          TOKEN_RESPONSE=$(curl -s -X POST "https://iam.cloud.ibm.com/identity/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=urn:ibm:params:oauth:grant-type:apikey&apikey=$IBM_CLOUD_API_KEY")
          ACCESS_TOKEN=$(echo $TOKEN_RESPONSE | jq -r '.access_token')
          echo "access_token=$ACCESS_TOKEN" >> $GITHUB_ENV

      - name: Send Main Branch Diff to WatsonX
        env:
          WATSONX_API_KEY: ${{ secrets.WATSONX_API_KEY }}
          WATSONX_URL: ${{ secrets.WATSONX_URL }}
        run: |
          # Diff between last two commits on main
          DIFF=$(git diff HEAD~1 HEAD)
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $access_token" \
            -H "Content-Type: application/json" \
            -d "{\"diff\": \"$DIFF\", \"language\": \"apex\"}" > review.json

      - name: Read WatsonX Review Output
        id: read_review
        run: |
          CONTENT=$(cat review.json | sed ':a;N;$!ba;s/\n/\\n/g')  # flatten multiline JSON
          echo "review=$CONTENT" >> $GITHUB_OUTPUT

      - name: Post WatsonX Review Comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            WatsonX Code Review Results:
            ```
            ${{ steps.read_review.outputs.review }}
            ```
